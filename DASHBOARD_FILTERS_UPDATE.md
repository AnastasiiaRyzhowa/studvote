# Обновление фильтров Dashboard - Исправление

## Проблема
1. В завершенных опросах ничего не отображалось
2. В активных отображался только один опрос
3. Счетчики показывали неправильные значения при переключении вкладок

## Причина
- **Бэкенд**: не обрабатывал параметр `has_voted` для фильтрации
- **Фронтенд**: счетчики считались от уже отфильтрованных данных, а не от всех опросов

## Исправления

### Backend: `/server/src/controllers/pollController.js`

**Добавлен параметр `has_voted`:**
```javascript
const {
  status,
  visibility,
  has_voted,  // ← Новый параметр
  page = 1,
  limit = 10
} = req.query;
```

**Добавлена логика фильтрации по голосованию:**
```javascript
// Фильтр по голосованию пользователя
if (has_voted === 'true' && req.user) {
  filter.voted_users = req.user.userId;
}
```

### Frontend: `/client/src/pages/DashboardMain.js`

**Изменена архитектура загрузки данных:**

1. **Новый state для всех опросов:**
```javascript
const [allPolls, setAllPolls] = useState([]); // Все опросы для счетчиков
```

2. **Загрузка всех опросов один раз:**
```javascript
useEffect(() => {
  loadPolls();
}, []); // ← Без зависимости от activeTab

const loadPolls = async () => {
  // Загружаем все опросы без фильтров
  const data = await getPolls({});
  const adaptedPolls = (data.polls || []).map(adaptPollData);
  setAllPolls(adaptedPolls);
};
```

3. **Клиентская фильтрация с useMemo:**
```javascript
const filteredPolls = useMemo(() => {
  switch (activeTab) {
    case 0: // Все
      return allPolls;
    case 1: // Активные
      return allPolls.filter(poll => poll.status === 'active');
    case 2: // Завершенные
      return allPolls.filter(poll => poll.status === 'completed');
    case 3: // Мои голоса
      return allPolls.filter(poll => poll.hasVoted);
    default:
      return allPolls;
  }
}, [activeTab, allPolls]);
```

4. **Правильный подсчет счетчиков:**
```javascript
// Счетчики считаются от allPolls, а не от filteredPolls
`Все (${allPolls.length})`,
`Активные (${allPolls.filter(p => p.status === 'active').length})`,
`Завершенные (${allPolls.filter(p => p.status === 'completed').length})`,
`Мои голоса (${allPolls.filter(p => p.hasVoted).length})`
```

## Преимущества нового подхода

✅ **Производительность:**
- Данные загружаются только один раз при монтировании
- Переключение между вкладками происходит мгновенно (только клиентская фильтрация)
- Нет лишних запросов к серверу

✅ **Корректность:**
- Счетчики всегда показывают правильные значения
- Каждая вкладка отображает правильное количество опросов
- Фильтрация работает согласно логике

✅ **UX:**
- Быстрое переключение между вкладками
- Синхронные счетчики
- Правильное отображение статусов "Участвовали" и "Пропущено"

## Результат

### Вкладки с правильными данными:
- **Все** - показывает все опросы
- **Активные** - только опросы со статусом `active`
- **Завершенные** - только опросы со статусом `completed`
- **Мои голоса** - только опросы где `hasVoted === true`

### Статусы на карточках:
- **Активен/Завершен** - базовый статус (зеленый градиент/серый)
- **✓ Участвовали** - зеленый чип с иконкой (если проголосовал)
- **⚠️ Пропущено** - серый чип с иконкой (если опрос завершен и не проголосовал)

### Счетчики:
- Показывают реальное количество опросов в каждой категории
- Не зависят от выбранной вкладки
- Обновляются при изменении данных

---

**Дата:** 23.12.2025  
**Статус:** ✅ Исправлено и протестировано


















